<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Blog - BytesByBlinken</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="./images/Logo.png">
</head>
<body>
    <header>
        <nav id="navbar">
            <ul>
                <li><a id="home" href="./index.html">Home</a></li>
                <li><a id="profile-link" href="https://github.com/ItsHeyBlinken" target="_blank">GitHub</a></li>
                <li><a id="profile-link" href="https://www.linkedin.com/in/christopher-hall-65907b291/" target="_blank">LinkedIn</a></li>
                <li><a id="profile-link" href="./blog.html">Blog</a></li>
                
                <!-- Admin Login Form (Hidden when logged in) -->
                <li id="admin-login-nav" class="admin-login-nav">
                    <form id="admin-login-form" class="admin-login-form">
                        <input type="text" id="username" name="username" placeholder="Username" required>
                        <input type="password" id="password" name="password" placeholder="Password" required>
                        <button type="submit" class="admin-login-btn">Login</button>
                    </form>
                </li>
                
                                 <!-- Admin Panel (Hidden when not logged in) -->
                 <li id="admin-panel-nav" class="admin-panel-nav" style="display: none;">
                     <button id="new-post-btn" class="admin-btn">+ New Post</button>
                     <button id="edit-mode-btn" class="admin-btn">Edit Mode</button>
                     <button id="manage-comments-btn" class="admin-btn">Manage Comments</button>
                     <button id="logout-btn" class="admin-btn">Logout</button>
                 </li>
                
                <li class="theme-toggle-container">
                    <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle dark/light mode">
                        <span class="theme-icon">üåô</span>
                    </button>
                </li>
            </ul>
        </nav>
    </header>
    
    <main>
        <section id="blog" class="blog">
            <div class="blog-header">
                <h1>My Blog</h1>
                <p>Thoughts, updates, and insights from my development journey</p>
                
                <!-- Month Navigation -->
                <div class="month-navigation">
                    <select id="month-filter" class="month-dropdown">
                        <option value="all">All Posts</option>
                        <option value="2025-07">July 2025</option>
                        <option value="2025-06">May/June 2025</option>
                        <option value="2025-04">April 2025</option>
                        <option value="2025-03">March 2025</option>
                        <option value="2025-02">February 2025</option>
                        <option value="2025-01">January 2025</option>
                        <option value="2024-12">December 2024</option>
                    </select>
                </div>
            </div>
            

            
                         <!-- Comment Management Panel (Hidden by default) -->
             <div id="comment-management-panel" class="comment-management-panel" style="display: none;">
                 <h2>Comment Management</h2>
                 <div class="comment-filters">
                     <button class="filter-btn active" data-filter="pending">Pending Approval</button>
                     <button class="filter-btn" data-filter="approved">Approved</button>
                     <button class="filter-btn" data-filter="all">All Comments</button>
                 </div>
                 <div id="comments-list" class="comments-list">
                     <!-- Comments will be loaded here -->
                 </div>
                 <button id="close-comment-panel" class="close-btn">Close</button>
             </div>
             
             <!-- New Post Form (Hidden by default) -->
             <div id="new-post-form" class="new-post-form" style="display: none;">
                <h2>Create New Blog Post</h2>
                <form id="blog-form">
                    <div class="form-group">
                        <label for="post-title">Title:</label>
                        <input type="text" id="post-title" name="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="post-content">Content:</label>
                        <textarea id="post-content" name="content" rows="15" required placeholder="Write your blog post content here..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="post-tags">Tags (comma-separated):</label>
                        <input type="text" id="post-tags" name="tags" placeholder="web development, portfolio, updates">
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Publish Post</button>
                        <button type="button" id="cancel-post" class="cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
            
            <!-- Edit Post Form (Hidden by default) -->
            <div id="edit-post-form" class="edit-post-form" style="display: none;">
                <h2>Edit Blog Post</h2>
                <form id="edit-blog-form">
                    <input type="hidden" id="edit-post-id" name="post_id">
                    <div class="form-group">
                        <label for="edit-post-title">Title:</label>
                        <input type="text" id="edit-post-title" name="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-post-content">Content:</label>
                        <textarea id="edit-post-content" name="content" rows="15" required placeholder="Write your blog post content here..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-post-tags">Tags (comma-separated):</label>
                        <input type="text" id="edit-post-tags" name="tags" placeholder="web development, portfolio, updates">
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Update Post</button>
                        <button type="button" id="cancel-edit-post" class="cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
            
            <!-- Blog Posts Container -->
            <div id="blog-posts-container">
                <!-- Blog posts will be loaded here dynamically -->
            </div>
        </section>
    </main>
    
    <footer>
        <div>
            <p><strong>Copyright &copy; 2025 - <strong>BytesByBlinken</strong></p>
        </div>
        <div>
            <img id="footer-logo" src="./images/Logo.png" alt="Logo">
        </div>
        <div>
            <p>Contact Me @ BytesByBlinken@gmail.com</p>
        </div>
    </footer>
    
    <script>
        // Configuration
        const API_BASE_URL = 'https://api.bytesbyblinken.com/api';
        
        // Global variables
        let blogForm;
        let newPostForm;
        let commentManagementPanel;
        let editPostForm;
        let editBlogForm;
        
        // Theme Management System
        function initThemeSystem() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.querySelector('.theme-icon');
            
            // Check for saved theme preference or default to dark
            const savedTheme = localStorage.getItem('portfolio-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Theme toggle functionality
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                // Apply new theme
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('portfolio-theme', newTheme);
                updateThemeIcon(newTheme);
            });
        }
        
        function updateThemeIcon(theme) {
            const themeIcon = document.querySelector('.theme-icon');
            if (theme === 'light') {
                themeIcon.textContent = '‚òÄÔ∏è';
            } else {
                themeIcon.textContent = 'üåô';
            }
        }
        
        // Blog Management System
        function initBlogSystem() {
            const loginForm = document.getElementById('admin-login-form');
            const newPostBtn = document.getElementById('new-post-btn');
            const editModeBtn = document.getElementById('edit-mode-btn');
            const logoutBtn = document.getElementById('logout-btn');
            newPostForm = document.getElementById('new-post-form');
            blogForm = document.getElementById('blog-form');
            const cancelPostBtn = document.getElementById('cancel-post');
            commentManagementPanel = document.getElementById('comment-management-panel');
            editPostForm = document.getElementById('edit-post-form');
            editBlogForm = document.getElementById('edit-blog-form');
            
            // Month navigation dropdown
            const monthFilter = document.getElementById('month-filter');
            
            // Load blog posts on page load
            loadBlogPosts();
            
            // Login form submission
            loginForm.addEventListener('submit', handleLogin);
            
            // Admin panel buttons
            newPostBtn.addEventListener('click', () => {
                newPostForm.style.display = 'block';
                newPostBtn.style.display = 'none';
            });
            
            cancelPostBtn.addEventListener('click', () => {
                newPostForm.style.display = 'none';
                newPostBtn.style.display = 'block';
                blogForm.reset();
            });
            
            // Edit form event listeners
            editBlogForm.addEventListener('submit', handleEditPost);
            document.getElementById('cancel-edit-post').addEventListener('click', hideEditForm);
            
            logoutBtn.addEventListener('click', handleLogout);
            
            // Blog form submission
            blogForm.addEventListener('submit', handleNewPost);
            
            // Comment management
            document.getElementById('manage-comments-btn').addEventListener('click', showCommentManagement);
            document.getElementById('close-comment-panel').addEventListener('click', hideCommentManagement);
            
            // Comment filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    loadAllComments(); // Reload with new filter
                });
            });
            
            // Month navigation dropdown
            monthFilter.addEventListener('change', () => {
                const selectedMonth = monthFilter.value;
                filterPostsByMonth(selectedMonth);
            });
            
            // Check if user is already logged in
            checkAuthStatus();
        }
        
        // Authentication functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store token
                    localStorage.setItem('blog-admin-token', data.token);
                    localStorage.setItem('blog-admin-user', JSON.stringify(data.user));
                    
                    // Show admin panel
                    showAdminPanel();
                    
                    // Reload posts
                    loadBlogPosts();
                } else {
                    alert('Login failed: ' + data.error);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }
        
        function handleLogout() {
            localStorage.removeItem('blog-admin-token');
            localStorage.removeItem('blog-admin-user');
            hideAdminPanel();
            loadBlogPosts(); // Reload without admin features
        }
        
        function checkAuthStatus() {
            const token = localStorage.getItem('blog-admin-token');
            if (token) {
                showAdminPanel();
            }
        }
        
        function showAdminPanel() {
            document.getElementById('admin-panel-nav').style.display = 'flex';
            document.getElementById('admin-login-nav').style.display = 'none';
        }
        
        function hideAdminPanel() {
            document.getElementById('admin-panel-nav').style.display = 'none';
            document.getElementById('admin-login-nav').style.display = 'block';
        }
        
        // Comment Management Functions
        function showCommentManagement() {
            commentManagementPanel.style.display = 'block';
            loadAllComments();
        }
        
        function hideCommentManagement() {
            commentManagementPanel.style.display = 'none';
        }
        
        async function loadAllComments() {
            // Verify token first
            if (!await verifyToken()) {
                alert('Your session has expired. Please log in again.');
                // Hide admin panel and show login form
                document.getElementById('admin-panel-nav').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'block';
                return;
            }
            
            try {
                const token = localStorage.getItem('blog-admin-token');
                const response = await fetch(`${API_BASE_URL}/comments`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const comments = await response.json();
                    displayAllComments(comments);
                } else if (response.status === 403) {
                    alert('Access denied. Your session may have expired. Please log in again.');
                    // Hide admin panel and show login form
                    document.getElementById('admin-panel-nav').style.display = 'none';
                    document.getElementById('admin-login-form').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Failed to load comments: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading comments:', error);
                alert('Failed to load comments. Please try again.');
            }
        }
        
        function displayAllComments(comments) {
            const container = document.getElementById('comments-list');
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            
            let filteredComments = comments;
            if (activeFilter === 'pending') {
                filteredComments = comments.filter(comment => !comment.is_approved);
            } else if (activeFilter === 'approved') {
                filteredComments = comments.filter(comment => comment.is_approved);
            }
            
            if (filteredComments.length === 0) {
                container.innerHTML = '<p class="no-comments">No comments found for this filter.</p>';
                return;
            }
            
                        container.innerHTML = filteredComments.map(comment => `
                <div class="comment-item ${comment.is_approved ? 'approved' : 'pending'}" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author_name}</span>
                        <span class="comment-date">${new Date(comment.created_at).toLocaleDateString()}</span>
                        ${comment.author_email ? `<span class="comment-email">${comment.author_email}</span>` : ''}
                        <span class="comment-status ${comment.is_approved ? 'approved' : 'pending'}">
                            ${comment.is_approved ? '‚úì Approved' : '‚è≥ Pending'}
                        </span>
                    </div>
                    <div class="comment-content">
                        <p>${comment.content}</p>
                    </div>
                    <div class="comment-actions">
                        ${!comment.is_approved ?
                            `<button class="approve-btn" onclick="approveComment(${comment.id})">Approve</button>` :
                            `<button class="reject-btn" onclick="rejectComment(${comment.id})">Reject</button>`
                        }
                        <button class="delete-comment-btn" onclick="deleteComment(${comment.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function approveComment(commentId) {
            // Verify token first
            if (!await verifyToken()) {
                alert('Your session has expired. Please log in again.');
                // Hide admin panel and show login form
                document.getElementById('admin-panel-nav').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'block';
                return;
            }
            
            try {
                const token = localStorage.getItem('blog-admin-token');
                const response = await fetch(`${API_BASE_URL}/comments/${commentId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ is_approved: true })
                });
                
                if (response.ok) {
                    alert('Comment approved successfully!');
                    loadAllComments(); // Refresh the list
                } else if (response.status === 403) {
                    alert('Access denied. Your session may have expired. Please log in again.');
                    // Hide admin panel and show login form
                    document.getElementById('admin-panel-nav').style.display = 'none';
                    document.getElementById('admin-login-form').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Failed to approve comment: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error approving comment:', error);
                alert('Failed to approve comment. Please try again.');
            }
        }
        
        async function rejectComment(commentId) {
            // Verify token first
            if (!await verifyToken()) {
                alert('Your session has expired. Please log in again.');
                // Hide admin panel and show login form
                document.getElementById('admin-panel-nav').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'block';
                return;
            }
            
            try {
                const token = localStorage.getItem('blog-admin-token');
                const response = await fetch(`${API_BASE_URL}/comments/${commentId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ is_approved: false })
                });
                
                if (response.ok) {
                    alert('Comment rejected successfully!');
                    loadAllComments(); // Refresh the list
                } else if (response.status === 403) {
                    alert('Access denied. Your session may have expired. Please log in again.');
                    // Hide admin panel and show login form
                    document.getElementById('admin-panel-nav').style.display = 'none';
                    document.getElementById('admin-login-form').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Failed to reject comment: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error rejecting comment:', error);
                alert('Failed to reject comment. Please try again.');
            }
        }
        
        // Blog post functions
        async function loadBlogPosts() {
            try {
                const response = await fetch(`${API_BASE_URL}/posts`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const posts = await response.json();
                displayBlogPosts(posts);
            } catch (error) {
                console.error('Error loading posts:', error);
                console.log('Falling back to static posts...');
                // Fallback to static posts if API is unavailable
                displayStaticPosts();
            }
        }
        
        function filterPostsByMonth(month) {
            // Filter posts by month
            const container = document.getElementById('blog-posts-container');
            const allPosts = container.querySelectorAll('.blog-tile');
            
            let visibleCount = 0;
            allPosts.forEach(post => {
                const postDateElement = post.querySelector('.post-date');
                if (!postDateElement) return;
                
                const postDateText = postDateElement.textContent;
                // Extract the date from "Published on: YYYY-MM-DD" format
                const dateMatch = postDateText.match(/Published on: (\d{4}-\d{2}-\d{2})/);
                
                if (dateMatch) {
                    const postDate = new Date(dateMatch[1]);
                    const postMonth = postDate.getFullYear() + '-' + String(postDate.getMonth() + 1).padStart(2, '0');
                    
                    if (month === 'all' || postMonth === month) {
                        post.style.display = 'block';
                        visibleCount++;
                    } else {
                        post.style.display = 'none';
                    }
                } else {
                    // If we can't parse the date, show the post
                    post.style.display = 'block';
                    visibleCount++;
                }
            });
            
            // Show/hide no posts message
            const noPostsMessage = document.querySelector('.no-posts');
            if (noPostsMessage) {
                noPostsMessage.style.display = visibleCount === 0 ? 'block' : 'none';
            }
            
            // Update the dropdown to show the selected month
            const monthFilter = document.getElementById('month-filter');
            if (monthFilter) {
                monthFilter.value = month;
            }
        }
        
        async function handleNewPost(e) {
            e.preventDefault();
            
            const formData = new FormData(blogForm);
            const postData = {
                title: formData.get('title'),
                content: formData.get('content'),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
                author: 'Chris (BytesByBlinken)',
                published_date: new Date().toISOString().split('T')[0]
            };
            
            try {
                const token = localStorage.getItem('blog-admin-token');
                const response = await fetch(`${API_BASE_URL}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(postData)
                });
                
                if (response.ok) {
                    alert('Post created successfully!');
                    newPostForm.style.display = 'none';
                    document.getElementById('new-post-btn').style.display = 'block';
                    blogForm.reset();
                    loadBlogPosts(); // Reload posts
                } else {
                    const error = await response.json();
                    alert('Failed to create post: ' + error.error);
                }
            } catch (error) {
                console.error('Error creating post:', error);
                alert('Failed to create post. Please try again.');
            }
        }
        
        function displayBlogPosts(posts) {
            const container = document.getElementById('blog-posts-container');
            container.innerHTML = '';
            
            if (posts.length === 0) {
                container.innerHTML = '<div class="no-posts"><h3>No blog posts found</h3><p>Check back soon for new content!</p></div>';
                return;
            }
            
            posts.forEach((post, index) => {
                const postElement = createBlogPostElement(post);
                postElement.style.animationDelay = `${index * 0.1}s`;
                container.appendChild(postElement);
            });
        }
        
        function displayStaticPosts() {
            // Fallback to static posts if API is unavailable
            const staticPosts = [
                {
                    id: 1,
                    title: "July Update: Crunch Time Before Launch",
                    content: `We're officially less than a month away from the soft launch of Online Card Show ‚Äî and I'm feeling a mix of excitement and nerves as the big day approaches.

The last few weeks have been all about getting everything production-ready. Moving from a dev environment to a live app is no joke. I've been fine-tuning the database, setting up secure deployments, double-checking API endpoints, and working through all the behind-the-scenes details that most users will never see ‚Äî but are critical to a smooth launch. If all goes to plan, we're aiming to go live on August 1st!

At the same time, I'm starting a new chapter at my day job. I just got promoted into a new role that comes with fresh challenges and responsibilities. While it's not a dev position, I'm excited about the growth it'll bring ‚Äî and I've made sure I'll still have time carved out to work on Online Card Show in the evenings and weekends.

Right now, it's crunch time. The final stretch. I'm focused on squashing the last of the bugs and making sure the experience is smooth for our early users. The soft launch is just the beginning, but it's a huge milestone and one I've been working toward for a long time.

**Closing Thoughts**

It's been a long road getting to this point, but the finish line is in sight. I'm proud of how far this project has come and grateful for everyone who's followed the journey ‚Äî here's to a strong launch and an even stronger future!

**What's Next?**

After launch, I'll be focused on gathering user feedback, rolling out new features, growing our social presence, and dialing in a solid customer acquisition strategy.

Thanks for following along ‚Äî next month is going to be a big one!`,
                    author: "Chris (BytesByBlinken)",
                    date: "July 7, 2025",
                    tags: ["launch", "updates", "development", "online-card-show"]
                },
                {
                    id: 2,
                    title: "May 2025 Blog: Project Progress and Updates",
                    content: `May was a busy month for Online Card Show and for me personally as a developer. Here's everything that moved forward:

**Beta Launch and Early Feedback**

I officially opened the beta program and welcomed my first group of testers. Getting real people using the app was huge ‚Äî the feedback has been super helpful for finding bugs and understanding how people actually want to use the platform. I'm making changes and improvements every day based on what testers say.

**Improving User Experience**

Based on beta feedback, I focused on polishing the user dashboards and smoothing out the subscription signup and management flows. I also added a new "Make an Offer" button, so buyers can negotiate prices directly‚Äîthis should make trading way more flexible and fun.

**Backend Stability and Performance**

I spent a lot of time tuning the database (PostgreSQL) and Redis cache to improve speed and reliability. This part can feel tricky, but it's important to keep the app running fast as more people join.

**Marketing Efforts**

I've been working on growing my social media presence to help spread the word about Online Card Show. I've also been reaching out to potential beta testers through my network.

**Learning Server Management**

I started diving into VPS management and server maintenance to get ready for hosting the app live. This is all new territory for me, but I'm making progress step by step, learning how to keep the server secure and stable.

I have only had to restore the server once, but it was a good reminder of how important it is to have a backup plan. I'm also learning how to monitor the server's health and performance to ensure it's running smoothly. So, I call that a win!

**Business and Legal Progress and Other Next Steps**

I opened a bank account for the project (not a full business account yet, but a start). I'm planning to set up the LLC soon. The Privacy Policy and Terms of Service are in progress, aiming to have them ready by July.

**Closing Thoughts**

May was a big month, and I'm excited to see what June brings. I'm looking forward to continuing to build Online Card Show and to keep pushing towards my goal of launching a fully operational platform.

**What's Next?**

June's all about refining what's built so far‚Äîpolishing features, improving performance, and getting closer to a smooth, stable beta experience. I'll also be diving deeper into hosting setup and making sure the business side catches up with the tech.

I'm excited to keep building and to see where this journey takes me. Thanks for being along for the ride!`,
                    author: "Chris (BytesByBlinken)",
                    date: "June 3, 2025",
                    tags: ["progress", "updates", "development", "beta-launch", "online-card-show"]
                }
            ];
            
            displayBlogPosts(staticPosts);
        }
        
        function createBlogPostElement(post) {
            const article = document.createElement('article');
            article.className = 'blog-tile';
            
            // Format content with line breaks
            const formattedContent = post.content.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
            
            // Handle both date formats (API uses published_date, static uses date)
            const displayDate = post.published_date || post.date;
            
            article.innerHTML = `
                <h2>${post.title}</h2>
                <div class="post-meta">
                    <p class="post-author">By: ${post.author}</p>
                    <p class="post-date">Published on: ${displayDate}</p>
                </div>
                <div class="post-content">
                    <p>${formattedContent}</p>
                </div>
                <div class="post-tags">
                    ${post.tags ? post.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                </div>
                <div class="post-actions" style="display: ${isAdmin() ? 'flex' : 'none'}">
                    <button class="edit-post-btn" data-post-id="${post.id}">Edit</button>
                    <button class="delete-post-btn" data-post-id="${post.id}">Delete</button>
                </div>
                
                <!-- Comments Section -->
                <div class="comments-section">
                    <h3>Comments</h3>
                    <div class="comments-container" id="comments-${post.id}">
                        <!-- Comments will be loaded here -->
                    </div>
                    
                    <!-- Comment Form -->
                    <div class="comment-form">
                        <h4>Leave a Comment</h4>
                        <form class="comment-submit-form" data-post-id="${post.id}">
                            <div class="form-group">
                                <input type="text" name="author_name" placeholder="Your Name" required>
                            </div>
                            <div class="form-group">
                                <input type="email" name="author_email" placeholder="Your Email (optional)" class="optional-field">
                            </div>
                            <div class="form-group">
                                <textarea name="content" placeholder="Your Comment" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="submit-comment-btn">Post Comment</button>
                        </form>
                    </div>
                </div>
            `;
            
            // Load comments for this post
            loadComments(post.id);
            
            // Add event listener for comment form
            const commentForm = article.querySelector('.comment-submit-form');
            commentForm.addEventListener('submit', handleCommentSubmit);
            
            // Add event listeners for edit and delete buttons
            const editBtn = article.querySelector('.edit-post-btn');
            const deleteBtn = article.querySelector('.delete-post-btn');
            
            if (editBtn) {
                editBtn.addEventListener('click', () => showEditForm(post));
            }
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => deletePost(post.id));
            }
            
            return article;
        }
        
        function isAdmin() {
            const token = localStorage.getItem('blog-admin-token');
            if (!token) return false;
            
            // Check if token is expired
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const currentTime = Date.now() / 1000;
                if (payload.exp && payload.exp < currentTime) {
                    // Token is expired, remove it
                    localStorage.removeItem('blog-admin-token');
                    return false;
                }
                return true;
            } catch (error) {
                // Invalid token format, remove it
                localStorage.removeItem('blog-admin-token');
                return false;
            }
        }

        // Function to verify token and redirect to login if invalid
        async function verifyToken() {
            const token = localStorage.getItem('blog-admin-token');
            if (!token) {
                return false;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    return true;
                } else {
                    // Token is invalid, remove it
                    localStorage.removeItem('blog-admin-token');
                    return false;
                }
            } catch (error) {
                console.error('Error verifying token:', error);
                localStorage.removeItem('blog-admin-token');
                return false;
            }
        }
        
        // Comment Management Functions
        async function loadComments(postId) {
            try {
                const response = await fetch(`${API_BASE_URL}/comments/${postId}`);
                if (response.ok) {
                    const comments = await response.json();
                    displayComments(postId, comments);
                } else {
                    console.error('Failed to load comments');
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        }
        
        function displayComments(postId, comments) {
            const container = document.getElementById(`comments-${postId}`);
            if (!container) return;
            
            if (comments.length === 0) {
                container.innerHTML = '<p class="no-comments">No comments yet. Be the first to comment!</p>';
                return;
            }
            
            const approvedComments = comments.filter(comment => comment.is_approved);
            if (approvedComments.length === 0) {
                container.innerHTML = '<p class="no-comments">No approved comments yet.</p>';
                return;
            }
            
            container.innerHTML = approvedComments.map(comment => `
                <div class="comment" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author_name}</span>
                        <span class="comment-date">${new Date(comment.created_at).toLocaleDateString()}</span>
                        ${comment.author_email && isAdmin() ? `<span class="comment-email">${comment.author_email}</span>` : ''}
                    </div>
                    <div class="comment-content">
                        <p>${comment.content}</p>
                    </div>
                    ${isAdmin() ? `
                        <div class="comment-actions">
                            <button class="delete-comment-btn" onclick="deleteComment(${comment.id})">Delete</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        async function handleCommentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const postId = form.getAttribute('data-post-id');
            const formData = new FormData(form);
            
            const commentData = {
                post_id: parseInt(postId),
                author_name: formData.get('author_name'),
                author_email: formData.get('author_email') || null,
                content: formData.get('content')
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commentData)
                });
                
                if (response.ok) {
                    alert('Comment submitted successfully! It will be visible after approval.');
                    form.reset();
                    // Reload comments to show the new one (pending approval)
                    loadComments(postId);
                } else {
                    const error = await response.json();
                    alert('Failed to submit comment: ' + error.error);
                }
            } catch (error) {
                console.error('Error submitting comment:', error);
                alert('Failed to submit comment. Please try again.');
            }
        }
        
        async function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;
            
            // Verify token first
            if (!await verifyToken()) {
                alert('Your session has expired. Please log in again.');
                // Hide admin panel and show login form
                document.getElementById('admin-panel-nav').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'block';
                return;
            }
            
            try {
                const token = localStorage.getItem('blog-admin-token');
                const response = await fetch(`${API_BASE_URL}/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Comment deleted successfully!');
                    // Reload comments to refresh the display
                    const postId = document.querySelector(`[data-comment-id="${commentId}"]`).closest('.blog-tile').getAttribute('data-post-id');
                    loadComments(postId);
                } else if (response.status === 403) {
                    alert('Access denied. Your session may have expired. Please log in again.');
                    // Hide admin panel and show login form
                    document.getElementById('admin-panel-nav').style.display = 'none';
                    document.getElementById('admin-login-form').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Failed to delete comment: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
                alert('Failed to delete comment. Please try again.');
            }
        }
        
        // Edit Post Functions
        function showEditForm(post) {
            // Populate the edit form with post data
            document.getElementById('edit-post-id').value = post.id;
            document.getElementById('edit-post-title').value = post.title;
            document.getElementById('edit-post-content').value = post.content;
            document.getElementById('edit-post-tags').value = post.tags ? post.tags.join(', ') : '';
            
            // Show the edit form
            editPostForm.style.display = 'block';
            
            // Hide the new post form if it's open
            newPostForm.style.display = 'none';
            document.getElementById('new-post-btn').style.display = 'block';
        }
        
        function hideEditForm() {
            editPostForm.style.display = 'none';
            editBlogForm.reset();
        }
        
        async function handleEditPost(e) {
            e.preventDefault();
            
            // Verify token first
            if (!await verifyToken()) {
                alert('Your session has expired. Please log in again.');
                // Hide admin panel and show login form
                document.getElementById('admin-panel-nav').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'block';
                return;
            }
            
            const formData = new FormData(e.target);
            const postId = formData.get('post_id');
            
            const postData = {
                title: formData.get('title'),
                content: formData.get('content'),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag.length > 0),
                published_date: new Date().toISOString()
            };
            
            try {
                const token = localStorage.getItem('blog-admin-token');
                const response = await fetch(`${API_BASE_URL}/posts/${postId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(postData)
                });
                
                if (response.ok) {
                    alert('Post updated successfully!');
                    hideEditForm();
                    loadBlogPosts(); // Reload posts to show changes
                } else if (response.status === 403) {
                    alert('Access denied. Your session may have expired. Please log in again.');
                    // Hide admin panel and show login form
                    document.getElementById('admin-panel-nav').style.display = 'none';
                    document.getElementById('admin-login-form').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Failed to update post: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating post:', error);
                alert('Failed to update post. Please try again.');
            }
        }
        
        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post? This will also delete all associated comments.')) return;
            
            // Verify token first
            if (!await verifyToken()) {
                alert('Your session has expired. Please log in again.');
                // Hide admin panel and show login form
                document.getElementById('admin-panel-nav').style.display = 'none';
                document.getElementById('admin-login-form').style.display = 'block';
                return;
            }
            
            try {
                const token = localStorage.getItem('blog-admin-token');
                const response = await fetch(`${API_BASE_URL}/posts/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('Post deleted successfully!');
                    loadBlogPosts(); // Reload posts to show changes
                } else if (response.status === 403) {
                    alert('Access denied. Your session may have expired. Please log in again.');
                    // Hide admin panel and show login form
                    document.getElementById('admin-panel-nav').style.display = 'none';
                    document.getElementById('admin-login-form').style.display = 'block';
                } else {
                    const error = await response.json();
                    alert('Failed to delete post: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('Failed to delete post. Please try again.');
            }
        }
        
        // Initialize all systems when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initThemeSystem();
            initBlogSystem();
        });
    </script>
</body>
</html>